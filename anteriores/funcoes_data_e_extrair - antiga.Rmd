---
title: "Funções para obter datas, extrair tabelas, "
author: "BML"
date: "2024-07-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
```


# Elementos de apoio
```{r}
planilhas <- dir(path = "data", pattern = "*xls*")
```


```{r eval=FALSE, include=FALSE}
# planilhas_novas <- c("2024_tabela-abril.xlsm", "2024_tabela-maio.xlsm", "2024_tabela-junho.xlsm")



# planilhas <- try(planilhas[!planilhas %in% planilhas_novas])
```



# Funções personalizadas

## Função 1: obter nomes de todas as guias
```{r}
# 2.1 - Obter nomes de todas as guias
extrair_guias <- function(num){
  readxl::excel_sheets(paste0("data/", planilhas[num]))}
```

## Função 2: extrair a data da planilha, usando a informação da guia 2

```{r}
importar_periodo <- function(x){
    df <- read_xlsx(paste0("data/", planilhas[x]), 
    sheet = 2, range = "O8", col_names = FALSE,
    .name_repair = "unique_quiet")
  
valor <- pull(df) 

{
  if (class(valor)[1] == "character") {valor <- my(valor)}
  if (class(valor)[1] == "POSIXct") {valor <- as.Date(valor)}
}

valor
}
```
Testar
```{r}
importar_periodo(1) 
importar_periodo(78)
importar_periodo(9) 
```
```{r}
extrair_data_novo <- importar_periodo
```


# Função 3: definir limites das tabelas

```{r eval=FALSE, include=FALSE}
importar_limites_tabelas <- function(nume, sheet = sheet){
  
  limite_tabelas <- data.frame()
  
  prov <- read_excel(paste0("data/", planilhas[nume]), sheet = sheet, .name_repair = "unique_quiet")
  names(prov)[1] <- "col1"
  
  linha_inicial <- which(str_detect(prov$col1, "Tabela [0-9]*")) + 2
  # E a a linha seguinte com a palavra tabela indica o início da tabela seguinte
  tamanho_tabela <- lead(linha_inicial) - linha_inicial - 4
  
  limite_tabelas <- data.frame(linha_inicial, tamanho_tabela)    
 
   # Definir linha da última tabela da guia
  limite_tabelas$tamanho_tabela[nrow(limite_tabelas)] <- nrow(prov) + 1  - limite_tabelas[nrow(limite_tabelas),1]
  
  limite_tabelas
}
```

Testar

```{r}
# planilhas[5]
# importar_limites_tabelas(nume = 5, sheet = 3)
```


## Função: Importar tabelas




```{r}
importar_tabela_limpa <- function(nume, sheet = sheet){
  prov <- read_excel(paste0("data/", planilhas[nume]), sheet = sheet, .name_repair = "unique_quiet")
  
  names(prov)[1] <- "col1"
  
  linha_inicial <- which(str_detect(prov$col1, "Tabela [0-9]*")) + 2
  # E a a linha seguinte com a palavra tabela indica o início da tabela seguinte
  tamanho_tabela <- lead(linha_inicial) - linha_inicial - 2
  
  limite_tabelas <- data.frame(linha_inicial, tamanho_tabela)
  
   # Definir linha da última tabela da guia
  limite_tabelas$tamanho_tabela[nrow(limite_tabelas)] <- nrow(prov) + 1  - limite_tabelas[nrow(limite_tabelas),1]
  
  minha_lista <- list()
  
    if(sheet != 2) {
    mes_boletim <- importar_periodo(nume) 
    
    i <- 1
  for(i in 1:nrow(limite_tabelas)){
    minha_lista[[i]] <- read_excel(paste0("data/", planilhas[nume]), sheet = sheet, skip = limite_tabelas$linha_inicial[i], n_max = limite_tabelas$tamanho_tabela[i], .name_repair = "unique_quiet") |> 
      mutate(mes = mes_boletim)
    i <- i + 1
  }
    
    }
  
      if(sheet == 2) {

    i <- 1
  for(i in 1:nrow(limite_tabelas)){
    minha_lista[[i]] <- read_excel(paste0("data/", planilhas[nume]), sheet = sheet, skip = limite_tabelas$linha_inicial[i], n_max = limite_tabelas$tamanho_tabela[i], .name_repair = "unique_quiet") 
    i <- i + 1
  }
    
    }
  
  minha_lista
}


```

Testar

```{r}
importar_tabela_limpa(5, sheet = 2)
```

```{r}
importar_tabela_limpa(15, sheet = 3)
```



Verificar se números são corretos
```{r warning=FALSE}

datas_boletins <- data.frame("boletim" = NA, "mês" = NA)

colunas_datas <- as.Date(NA)
i <- 1
for(i in seq_along(planilhas)){

datas_boletins[i,1] <- planilhas[i]
    
  mes_planilha <- read_excel(paste0("data/", planilhas[i]), 
    sheet = 2, 
    range = "O8", col_names = FALSE, col_types = "text")
  
mes_planilha <- pull(mes_planilha) 

{
  if (str_detect(mes_planilha, "/") == TRUE) {mes_planilha_f <- lubridate::my(mes_planilha)}
  
  else {mes_planilha_f <- as.Date(as.numeric(mes_planilha), origin = "1899-12-30")} 
}

colunas_datas[i] <- mes_planilha_f
    
    i <- 1 + i
}
datas_boletins[,2] <- colunas_datas


```

```{r eval=FALSE, include=FALSE}
datas_boletins <- data.frame("boletim" = NA, "mês" = NA)

colunas_datas <- as.Date(NA)
i <- 1
for(i in seq_along(planilhas)){

datas_boletins[i,1] <- planilhas[i]
    
colunas_datas[i] <- extrair_data_novo(i)
    
    i <- 1 + i
}
datas_boletins[,2] <- colunas_datas
```


```{r}
colunas_datas
datas_boletins
```



# Criar arquivo 


# Guias
```{r}
guias_lista <- map(1:length(planilhas), extrair_guias)

guias <- do.call(rbind, guias_lista) |> 
  as_tibble() 

guias <- guias |> 
  mutate(V5 = str_remove_all(V5, "Lista de Tabelas")) |> 
  mutate(num_arquivo = 1:nrow(guias) )
```

```{r}
guias
```
Nomes únicos de guias:
```{r}
unique(guias[,1:5])
```



# Covid

Identificar as planilhas onde há guias com tabelas da Covid 19, e quantas tabelas há nelas:

```{r}
guias_covid <- guias |> 
   filter(str_detect(V5, "Covid")) |> 
  pull(num_arquivo)

```





# Extrair tabelas de planilhas (qualquer número de tabelas)

```{r}
extrair_todas_tabelas <- function(nume, sheet = sheet){
  prov <- read_excel(paste0("data/", planilhas[nume]), sheet = sheet)
  
  names(prov)[1] <- "col1"
  
  corte <- which(str_detect(prov$col1, "Tabela [0-9]*"))
  # E a a linha seguinte com a palavra tabela indica o início da tabela seguinte
  maximo_linha <- lead(corte) - corte
  
  # tamanho da última tabela: número total de linhas do DF - linha da última tabela do DF
  # substituir esse valor no vetor, que aparece como "NA"
  ultima_n_max <- nrow(prov) - corte[length(corte)]
  
  maximo_linha[length(maximo_linha)] <- ultima_n_max + 2
  
  ajuste <- 2
  ajuste2 <- -2
  
  maximo_linha
  
  minha_lista <- list()
  
    if(sheet != 2) {
    mes_boletim <- extrair_data_novo(nume) 
    
    i <- 1
  for(i in seq_along(corte)){
    minha_lista[[i]] <- read_excel(paste0("data/", planilhas[nume]), sheet = sheet, skip = corte[i] + 
                                     ajuste, n_max = maximo_linha[i] + ajuste2) |> 
      mutate(mes = mes_boletim)
    i <- i + 1
  }
    
    }
  
      if(sheet == 2) {

    
    i <- 1
  for(i in seq_along(corte)){
    minha_lista[[i]] <- read_excel(paste0("data/", planilhas[nume]), sheet = sheet, skip = corte[i] + 
                                     ajuste, n_max = maximo_linha[i] + ajuste2) 
    i <- i + 1
  }
    
    }
  
  minha_lista
}

```

### Função 3: extrair todas as tabelas


```{r}
extrair_todas_tabelas_novo <- function(x, nume, sheet = sheet){
  mes_boletim <- extrair_data_novo(nume)
  
  prov <- read_excel(paste0("data/", x), sheet = sheet)
  
  names(prov)[1] <- "col1"
  
  corte <- which(str_detect(prov$col1, "Tabela [0-9]*"))
  # E a a linha seguinte com a palavra tabela indica o início da tabela seguinte
  maximo_linha <- lead(corte) - corte
  
  # tamanho da última tabela: número total de linhas do DF - linha da última tabela do DF
  # substituir esse valor no vetor, que aparece como "NA"
  ultima_n_max <- nrow(prov) - corte[length(corte)]
  
  maximo_linha[length(maximo_linha)] <- ultima_n_max + 2
  
  ajuste <- 2
  ajuste2 <- -2
  
  maximo_linha
  
  minha_lista <- list()
  
  
  i <- 1
  for(i in seq_along(corte)){
    minha_lista[[i]] <- read_excel(paste0("data/", x), sheet = sheet, skip = corte[i] + 
                                     ajuste, n_max = maximo_linha[i] + ajuste2) |> 
      mutate(mes = mes_boletim)
    i <- i + 1
  }
  
  minha_lista
}
```

### Extrair tabelas - passo a passo

Obter os números de linhas que contêm a palavra tabela (planilha de maio/2024)
```{r}
library(readxl)
library(tidyverse)
planilha_maio <- "data/2024_tabela-maio.xlsm"

primeira_importacao <- read_xlsx(path = planilha_maio, sheet = 2)
names(primeira_importacao)[1] <- "col1"
corte <- which(str_detect(primeira_importacao$col1, "Tabela [0-9]*"))
maximo_linha <- lead(corte) - corte

ultima_n_max <- nrow(primeira_importacao) - corte[length(corte)]
maximo_linha[length(maximo_linha)] <- ultima_n_max + 2

primeira_linha <- corte + 2
tamanho_tabela <- maximo_linha - 2
```
Há um vetor com o número da primeira_linha, e outro com o tamanho da tabela. Eles serão alimentados para gerar uma list
```{r}
lista_exemplo <- list()

i <- 1 
for(i in seq_along(primeira_linha)) {
  lista_exemplo[[i]] <- read_excel(path = planilha_maio, sheet = 2, skip = primeira_linha[i], n_max = tamanho_tabela[i])
}

lista_exemplo
```


# Outras
## Contar quantas tabelas há aquela guia
```{r}
contar_tabelas <- function(nume, ajuste = 2, ajuste2 = -2, sheet = sheet){
prov <- read_excel(paste0("data/", planilhas[nume]), sheet = sheet)

names(prov) <- "col1"

corte <- which(str_detect(prov$col1, "Tabela [0-9]*"))

print(length(corte))
}

i <- 1
for(i in 51:60){
contar_tabelas(i, sheet = 4)  
  i <- 1 + 1
}
```


## Não são utilizadas mais


# Gerar elemento com datas

Gerando elemento (dataframe) com todos os arquivos e suas datas
```{r message=FALSE, warning=FALSE}
# datas_arquivos <- map_df(seq_along(planilhas), extrair_data_ws2) |> 
#  mutate(planilha = planilhas)

# datas_arquivos
```

```{r message=FALSE, warning=FALSE}
# Verificando os erros

#{if (datas_arquivos |> 
#  filter(is.na(value))  |> 
#  nrow()  == 0 ) {print("Sem erros")}
#else (print("Verificar"))  } 

```
