---
title: "Worksheets das planilhas"
author: "BML"
date: "2024-06-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(plyr)
library(tidyverse)
library(readxl)
library(qpcR)
library(janitor)

```


Funções personalizadas


A função personalizada "read_excel_data" importa todo o conteúdo que está nas planilhas, dentro do rage "A1:M1000". Isso garante que todos os objetos importados tenham o mesmo número de colunas, o que facilita o uso das funções map e map_df.



```{r}
excel_sheets_data <- function(x){
  excel_sheets(paste0("data/", x))
}

read_excel_data  <- function(x,sheet = 1, range = "A1:J1000", skip = 0){
  read_xlsx(paste0("data/", x), col_types = "text",
             sheet = sheet,
              range = range,
                skip = skip,
               col_names = FALSE,
               .name_repair = "unique_quiet",)
}

padronizar_nomes <- function(x){x |> 
  mutate(...2 = str_remove_all(...2, "Tabela [0-9]+")) |>
  mutate(...2 = str_remove_all(...2, "\\. ")) |>  
  mutate(...2 = str_to_lower(...2) ) %>% 
  mutate(...2 = str_replace_all(...2, "³", "3")) |>
  mutate(...2 = str_replace_all(...2, "mmm", "mm"),
         ...2 = str_replace_all(...2, "mm", "mmm")) 
}

```



## Análise do conjunto das planilhas

Criar objeto com nomes das planilhas

Como as planilhas estão no no diretório "data", é preciso usar a função "paste0" e o parâmetro "data/".

```{r}
# planilhas <- dir(pattern = "*xls*")
planilhas <- dir(path = "data", pattern = "*xls*")

```



Quantas planilhas?

```{r}
num_planilhas <- seq_along(planilhas)
num_planilhas
```
`r num_planilhas` planilhas

Gerando uma lista com todos os nomes de abas
```{r}
nomes_abas <- planilhas |> 
  map(~{.x %>% 
            excel_sheets_data })

```

Como geramos uma lista com vetores de tamanhos diferentes e um dataframe é a melhor maneira de tratar dados no R, vamos usar uma função que está no pacote plyr, a ldply.
```{r}
nomes_abas_df <- plyr::ldply(nomes_abas,rbind) 
nomes_abas_df %>% 
  distinct(`1`, `2`,`3`,`4`, `5`)
```

Há três grupos de planilhas:
1 - há 4 worksheets, e a 4a worksheet é "3. Movimentação de Gás Natural"; 
2 - há 4 worksheets, e a 4a worksheet é "3. Ranking";
3 - há 5 worksheets, e a 5a worksheet é 4. "Pandemia_Covid-19"

A primeira aba, "Lista de tabelas", é composta de uma maneira que não pode ser lida no R. Ela pode ser ignorada, então. 

```{r}

read_excel("data/2019-10-boletim-tabelas.xlsm", 
    sheet = 1)

```

Vamos buscar o nome de todas as tabelas que estão dentro das worksheets.

Tabelas que estão na worksheet 2:

```{r}
tabelas2 <- map_df(planilhas, read_excel_data, sheet = 2)  |> 
  filter(if_any(2, ~ str_detect(., "Tabela")))  |> 
  padronizar_nomes() |> 
  distinct(...2)  |> 
  rename("Histórico de Produção" = ...2)

```
As tabelas que estão na worksheet 3:

```{r}
tabelas3 <- map_df(planilhas, read_excel_data, sheet = 3)  |> 
  filter(if_any(2, ~ str_detect(., "Tabela")))  |> 
 padronizar_nomes() |> 
  distinct(...2)  |> 
  rename("Dados de Produção" = ...2)
```
Algumas tabelas que estão na worksheet 4 dizem respeito a "Movimentação de Gás Natural", outras dizem respeito a ranking. Os dois grupos vão ser separados. 

As tabelas que estão na worksheet 4 são:
```{r}
planilhas_movimentacao <- nomes_abas_df |> 
  mutate(num_linha = 1:nrow(nomes_abas_df)) |> 
  filter(str_detect(`4`, "Movimentação")) |> 
  pull(num_linha)

tabelas4_1 <- map_df(planilhas[planilhas_movimentacao], read_excel_data, sheet = 4) |> 
  filter(if_any(2, ~ str_detect(., "Tabela")))  |> 
  padronizar_nomes() |>
  distinct(...2)  |> 
  rename("Movimentação de Gás Natural" = ...2)
```


```{r}
planilhas_ranking <- nomes_abas_df |> 
  mutate(num_linha = 1:nrow(nomes_abas_df)) |> 
  filter(str_detect(`4`, "Ranking")) |> 
  pull(num_linha)

tabelas4_2 <- map_df(planilhas[planilhas_ranking], read_excel_data, sheet = 4) |> 
  filter(if_any(2, ~ str_detect(., "Tabela")))  |> 
  padronizar_nomes() |>
  distinct(...2)  |> 
  rename("Ranking" = ...2)
  
```

Tabelas adicionais:

```{r}
tabelas4_3 <- map_df(planilhas, read_excel_data, sheet = 4)  |> 
  filter(if_any(2, ~ str_detect(., "Tabela")))  |> 
  padronizar_nomes() |>
  filter(str_detect(...2, "tabela adicional")) |> 
  distinct(...2)  |> 
  rename("Tabelas adicionais" = ...2) 
```
Nem todas as planilhas têm a aba 5. Para extrair os nomes das tabelas fazemos um filtro antes.

```{r}
planilhas_com_5 <- nomes_abas_df |> 
  mutate(num_linha = 1:nrow(nomes_abas_df)) |> 
  filter(!is.na(`5`)) |> 
  pull(num_linha)

tabelas5 <- map_df(planilhas[planilhas_com_5], read_excel_data, sheet = 5) |> 
  filter(if_any(2, ~ str_detect(., "Tabela")))  |> 
  padronizar_nomes() |>
  distinct(...2)  |> 
  rename("Pandemia_Covid-19" = ...2) 
```

Essas são as tabelas que estão disponíveis nas diferentes planilhas.

```{r}
tabelas <- gdata::cbindX(tabelas2, tabelas3, tabelas4_1, tabelas4_2, tabelas4_3, tabelas5)

tabelas
```

## Data do arquivo

A informação do mês de cada planilha está em uma caixa de texto. Vamos dedicar um script para essa tarefa.

## Separando as tabelas

Em cada worksheet há várias tabelas. Com esse procedimento podemos 

```{r}
provisorio <-  read_excel_data(planilhas[1], sheet = 2) 

linhas_vazias <- rowSums(is.na(provisorio))==ncol(provisorio)

# cria várias listas. a ímpar tem o nome, a par tem 
split(subset(provisorio,!linhas_vazias),cumsum(linhas_vazias)[!linhas_vazias])

```

```{r}
provisorio3 <-  read_excel_data(planilhas[1], sheet = 3) 

linhas_vazias3 <- rowSums(is.na(provisorio3))==ncol(provisorio3)

# cria várias listas. a ímpar tem o nome, a par tem 
lista3 <- split(subset(provisorio3,!linhas_vazias3),cumsum(linhas_vazias3)[!linhas_vazias3])
```

Os itens pares mostram o título da tabela, os itens impares os dados

```{r}
lista3[2]
```

Para transformar a primeira linha em nome de coluna:
```{r}
lista3_3 <- lista3[[3]]
row_to_names(lista3_3, 1)
```

