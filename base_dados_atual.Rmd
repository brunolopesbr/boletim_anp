---
title: "Tabelas versão atual"
author: "BML"
date: "2024-07-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
```

```{r}
source(knitr::purl("funcoes_data_e_extrair.Rmd", quiet=TRUE))
```

# Tabelas 1 a 4: 

```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 2, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) 
```

## Criação de listas com as tabelas

```{r}
lista_guia2_todas <- map(1:76, extrair_todas_tabelas, sheet = 2)
```
As três primeiras planilhas têm tabelas diferentes das demais, 
```{r}
lista_guia2_3_primeiras <- lista_guia2_todas[c(1:3)]

lista_guia2_restantes <- lista_guia2_todas[-c(1:3)]
```


## Histórico de produção de petróleo

```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 2, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(1)

read_excel(paste0("data/", planilhas[4]), sheet = 2, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(1)

read_excel(paste0("data/", planilhas[1]), sheet = 2, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(1)
```

```{r}
tabela_1. <- try(map_df(lista_guia2_todas, `[[`, 1)  ) |> 
  # reirar coluna mês
  select(!mes) |> 
  gather(key = "Período", value = "produto", -1)
  
tabela_1 <- rbind(tabela_1. |> 
       filter(str_detect(Período, "/")) |> 
  mutate(Período = my(Período)) |> 
  filter(!is.na(produto)),

tabela_1. |> 
  filter(!str_detect(Período, "/")) |> 
  mutate(Período = as.Date(as.numeric(Período), origin = "1899-12-30")) |> 
  filter(!is.na(produto))) |> 
  distinct()

```



## Histórico de produção de gás natural

```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 2, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(2)

read_excel(paste0("data/", planilhas[4]), sheet = 2, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(2)

read_excel(paste0("data/", planilhas[1]), sheet = 2, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(2)

```

```{r}
Historico_prod_gas <- map_df(lista_guia2_todas, `[[`, 2)   |> 
  # reirar coluna mês
  select(!mes) |> 
  gather(key = "Período", value = "produto", -1) |> 
  distinct() |> 
   mutate(Período = my(Período)) |> 
  filter(!is.na(produto)) 
```




## Histórico da movimentação da gás natural 

```{r}
read_excel(paste0("data/", planilhas[4]), sheet = 2, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(3)
```


```{r}
try(map_df(lista_guia2_todas, `[[`, 3)  )
```
Erro: Coluna período está definida como "datetime" ou "character"
Mas ele esconde outro problema: os três primeiros dataframes não dizem respeito.
Criada nova lista, que considera os dados das planilhas 4 (janeiro de 2018) em diante 


```{r}
lista_guia2_3_primeiras <- lista_guia2_todas[c(1:3)]

lista_guia2_restantes <- lista_guia2_todas[-c(1:3)]

```

```{r}
try(map_df(lista_guia2_restantes, `[[`, 3)  )
```
### 1. Retirar a coluna `Nº`


```{r}
i <- 1
for(i in seq_along(lista_guia2_restantes)){
names(lista_guia2_restantes[[i]][[3]]) |> print()
  i <- 1 + 1
}
```


### 2. Verificar qual DF tem colunas demais 

```{r}
meu_dataframe <- data.frame()

i <- 1
for(i in seq_along(lista_guia2_restantes)){
meu_dataframe[i,1] <- ncol(lista_guia2_restantes[[i]][[3]]) 
  i <- 1 + 1
}

meu_dataframe |> 
  mutate(num = 1:nrow(meu_dataframe)) |> 
  filter(V1 > 8)


```

### Verificar nomes das colunas (talvez sejam tabelas com conteúdos diferentes)

```{r}
i <- 1
for(i in seq_along(lista_guia2_restantes)){
names(lista_guia2_restantes[[i]][[3]]) |> print()
  i <- 1 + 1
}
```
```{r}
# Mudar nome de coluna - de Período para "Mês/Ano
i <- 1
for(i in seq_along(lista_guia2_restantes)){
names(lista_guia2_restantes[[i]][[3]]) <- names(lista_guia2_restantes[[i]][[3]]) |> 
  str_replace_all(pattern = "Período", replacement = "Mês/Ano")
  i <- 1 + 1
}
```
Detectar quais dataframes têm as datas condificadas como "mês/ano" e transformar em data:
```{r}
i <- 1
for(i in seq_along(lista_guia2_restantes)){

  if(lista_guia2_restantes[[i]][[3]][,1] |>  str_detect("/") == TRUE) {lista_guia2_restantes[[i]][[3]][,1] <- lista_guia2_restantes[[i]][[3]][,1] |>  mutate("Mês/Ano" = my(`Mês/Ano`))
}
  i <- 1 + 1  
}

```



 

```{r}
 MOVIMENTACAO_DE_GAS_NATURAL <- map_df(lista_guia2_restantes, `[[`, 3)  
```



## Histórico de Produção de Petróleo e Gás Natural

```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 2, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(4)

read_excel(paste0("data/", planilhas[1]), sheet = 2, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(3)
```

Usamos a quarta tabela, das planilhas 4 em diante 
```{r}
Historico_de_Producao_de_Petroleo_Gas_Natural <-  try(map_df(lista_guia2_restantes, `[[`, 4)  )  |> 
  select(!mes) |> 
  gather(key = "Período", value = "produto", -1) |> 
  distinct() |> 
   mutate(Período = my(Período)) |> 
  filter(!is.na(produto)) 
```






# Tabelas 5 a 10
```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) 
```

## Criação de listas com as tabelas (guia 3)

```{r}
lista_guia3_todas <- map(1:76, extrair_todas_tabelas, sheet = 3)
```

Como as três primeiras planilhas podem ter tabelas diferentes das outras, criamos duas listas: uma apenas com essas três primeiras planilhas, e outra sem elas
```{r}
lista_guia3_3_primeiras <- lista_guia3_todas[c(1:3)]

lista_guia3_restantes <- lista_guia3_todas[-c(1:3)]
```


## Produção por estado

```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(1)

read_excel(paste0("data/", planilhas[4]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(1)

read_excel(paste0("data/", planilhas[1]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(1)
```

```{r}
try(map_df(lista_guia3_todas, `[[`, 1) )

# Acertando os nomes:
i <- 1
for(i in seq_along(lista_guia3_todas)){
names(lista_guia3_todas[[i]][[1]]) <- names(lista_guia3_todas[[1]][[1]])
  i <- 1 + 1
}

por_estado <- map_df(lista_guia3_todas, `[[`, 1) 
```


## por Bacia


```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(2)

read_excel(paste0("data/", planilhas[4]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(2)

read_excel(paste0("data/", planilhas[1]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(2)
```

```{r}
try(map_df(lista_guia3_todas, `[[`, 2) )

# Acertar nomes das colunas

i <- 1
for(i in seq_along(lista_guia3_todas)){
names(lista_guia3_todas[[i]][[2]]) <- names(lista_guia3_todas[[1]][[2]])
  i <- 1 + 1
}

por_bacia <- map_df(lista_guia3_todas, `[[`, 2) 
```

## por operador

```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(3)

read_excel(paste0("data/", planilhas[4]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(3)

read_excel(paste0("data/", planilhas[1]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(3)
```

```{r}


# Retirar a coluna `Nº`

i <- 1
for(i in seq_along(lista_guia3_todas)){
lista_guia3_todas[[i]][[3]] <- select(lista_guia3_todas[[i]][[3]], !"Nº")
  i <- 1 + 1
}

por_operador <- map_df(lista_guia3_todas, `[[`, 3) 

```


## por concessionario

```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(4)

read_excel(paste0("data/", planilhas[4]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(4)

read_excel(paste0("data/", planilhas[1]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(4)
```
```{r}
try(map_df(lista_guia3_todas, `[[`, 4))
```


```{r}
# Verificação básica
# Verificar qual DF tem colunas demais

i <- 1
for(i in 71:75){
ncol(lista_guia3_todas[[i]][[4]]) |> print()
  i <- 1 + 1
}

```
```{r}
# Apagar colunas que não fazem sentido
lista_guia3_todas[[73]][[4]] <- lista_guia3_todas[[73]][[4]] |> 
  select(!6:10)
```



```{r}
# Retirar a coluna `Nº`

i <- 1
for(i in seq_along(lista_guia3_todas)){
lista_guia3_todas[[i]][[4]] <- select(lista_guia3_todas[[i]][[4]], !"Nº")
  i <- 1 + 1
}

# Acertar nomes

i <- 1
for(i in seq_along(lista_guia3_todas)){
names(lista_guia3_todas[[i]][[4]]) <- names(lista_guia3_todas[[1]][[4]])
  i <- 1 + 1
}
```

```{r}
por_concessionario <- map_df(lista_guia3_todas, `[[`, 4)
```

## Movimentação de gás natural por destinação

```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(5)

read_excel(paste0("data/", planilhas[4]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(5)

# Está na guia 5, tabela 2 
read_excel(paste0("data/", planilhas[1]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
    select(1) |> 
  slice(2)

```

```{r}
# Verificar qual DF tem colunas demais

i <- 1
for(i in 70:76){
ncol(lista_guia3_todas[[i]][[5]]) |> print()
  i <- 1 + 1
}

```
Verificar nomes das colunas

```{r}
i <- 1
for(i in seq_along(lista_guia3_todas)){
names(lista_guia3_todas[[i]][[5]]) |> print()
  i <- 1 + 1
}
```
Tabelas nas planilhas 1 a 3 dizem respeito a outros dados, não devem ser unidos. Usando a lista que não tem essas tabelas. 

```{r}
MOVIMENTACAO_GAS_NATURAL_POR_DESTINO <- map_df(lista_guia3_restantes, `[[`, 5)
```

## Distribuição da produção dos campos do Pré-sal

```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(6)

read_excel(paste0("data/", planilhas[4]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(6)

read_excel(paste0("data/", planilhas[1]), sheet = 3, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(6)
```
```{r}
try(map_df(lista_guia3_todas, `[[`, 6)) 
```

```{r}
# Verificação básica
# Verificar qual DF tem colunas demais

i <- 1
for(i in seq_along(lista_guia3_todas)){
ncol(lista_guia3_todas[[i]][[6]]) |> print()
  i <- 1 + 1
}

```

```{r}

# Mostrar nomes
i <- 1
for(i in seq_along(lista_guia3_todas)){
names(lista_guia3_todas[[i]][[6]]) |> print()
  i <- 1 + 1
}

```
Acertar nomes

```{r}

i <- 1
for(i in seq_along(lista_guia3_todas)){
  names(lista_guia3_todas[[i]][[6]]) <- names(lista_guia3_todas[[70]][[6]])
}
```


Verificando o início da tabela, considerando três números aleatórios

```{r}
# gerando números aleatórios
set.seed(100)
aleatorios <- runif(3, min= 1, max = 70)

i <- 1
for(i in aleatorios){
head(lista_guia3_todas[[i]][[6]]) |> print()
  i <- 1 + 1
}
```
Problema: primeira linha de algumas tabelas tem caracteres, ao invés de números.

Solução: apagar primeira linha, se ela existir.

```{r}
# Se a primeira linha da primeira coluna for nula, apagar linha e converter as colunas 2 a 7 para valores numéricos
i <- 1

for(i in seq_along(lista_guia3_todas)) {
if(is.na(lista_guia3_todas[[i]][[6]][1,1])) {lista_guia3_todas[[i]][[6]] <- lista_guia3_todas[[i]][[6]][-1,] |> 
  mutate_at(2:7, as.numeric)}    
  i <- 1 + i
}
```

Verificar nomes

```{r}
i <- 1 
for(i in seq_along(lista_guia3_todas)){
  names(lista_guia3_todas[[i]][[6]]) |> print()
  i <- i + 1
}
```

```{r}
DISTRIBUICAO_DA_PRODUCAO_CAMPOS_PRE_SAL <- map_df(lista_guia3_todas, `[[`, 6)
```





# Tabelas 11 a 18 (Guia 4)

## Criar lista


```{r}

lista_guia4_todas <- map(seq_along(planilhas), extrair_todas_tabelas, sheet = 4)
```
Da base de dados, a guia 4 das planilhas 1 a 3 (outubro a dezembro de 2010) contêm tabelas diferentes, e não devem ser incluídas junto co as outras na base de dados.

```{r}
lista_guia4_todas_reserva <- lista_guia4_todas

lista_guia4_todas <- lista_guia4_todas[-c(1,2,3)]

```



## 30 maiores poços de petróelo

```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(1)

read_excel(paste0("data/", planilhas[32]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(1)

read_excel(paste0("data/", planilhas[4]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(1)
```

```{r}
try(map_df(lista_guia4_todas, `[[`, 1))
```

## 1. Acertar nomes 


```{r}
# Acertar nomes das colunas
names(lista_guia4_todas[[1]][[1]] ) |> 
  str_remove_all("Nome ANP do ")

names(lista_guia4_todas[[70]][[1]] ) |> 
  str_remove_all("Nome ANP do ")
```


```{r}
i <- 1
for(i in seq_along(lista_guia4_todas)){
  names(lista_guia4_todas[[i]][[1]] ) <- names(lista_guia4_todas[[i]][[1]] ) |> 
  str_remove_all("Nome ANP do ")
  i <- i + 1
}

```

```{r}
maiores_pocos_de_petroleo <- map_df(lista_guia4_todas, `[[`, 1)
```



## 30 maiores poços de gas

```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(2)

read_excel(paste0("data/", planilhas[32]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(2)

read_excel(paste0("data/", planilhas[4]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(2)
```

```{r}
try(map_df(lista_guia4_todas, `[[`, 2))
```
Acertar nomes das colunas

```{r}


i <- 1
for(i in seq_along(lista_guia4_todas)) {
  names(lista_guia4_todas[[i]][[2]] ) <- names(lista_guia4_todas[[i]][[2]] ) |> 
  str_replace_all(pattern = "Natural", replacement = "natural") |> 
  str_remove_all("Nome ANP do ")
  i <- i + 1
}
```

```{r}
maiores_pocos_de_gas <- map_df(lista_guia4_todas, `[[`, 2)
```


## 30 maiores poços produção total

```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(3)

read_excel(paste0("data/", planilhas[32]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(3)

read_excel(paste0("data/", planilhas[4]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(3)
```

```{r}
try(map_df(lista_guia4_todas, `[[`, 3))
```
1. Acertar os nomes das colunas

```{r}
i <- 1
for(i in seq_along(lista_guia4_todas)) {
  names(lista_guia4_todas[[i]][[3]] ) <- names(lista_guia4_todas[[i]][[3]] ) |> 
  str_replace_all(pattern = "Natural", replacement = "natural") |> 
  str_remove_all("Nome ANP do ")
  i <- i + 1
}

```

```{r}
try(map_df(lista_guia4_todas, `[[`, 3))
```
2. Verificar qual DF tem colunas demais 

```{r}
i <- 1
for(i in 60:74){
ncol(lista_guia4_todas[[i]][[3]]) |> print()
  i <- 1 + 1
}
```
# DFs 62 e 72

```{r}
# Apagar colunas que não fazem sentido
lista_guia4_todas[[62]][[3]] <- lista_guia4_todas[[62]][[3]] |> select(!7:12) 
lista_guia4_todas[[72]][[3]] <- lista_guia4_todas[[72]][[3]] |> select(!7:12) 
```

```{r}
maiores_pocos_producao_total <- map_df(lista_guia4_todas, `[[`, 3)
```



## 30 maiores poços terrestres

```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(4)

read_excel(paste0("data/", planilhas[32]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(4)

read_excel(paste0("data/", planilhas[4]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(4)
```

```{r}
try(map_df(lista_guia4_todas, `[[`, 4))
```

1. Acertar os nomes das colunas

```{r}
i <- 1
for(i in seq_along(lista_guia4_todas)) {
  names(lista_guia4_todas[[i]][[4]] ) <- names(lista_guia4_todas[[i]][[4]] ) |> 
  str_replace_all(pattern = "Natural", replacement = "natural") |> 
  str_replace_all(pattern = "Operador/Concessionário", replacement = "Operador") |>  
    
  str_remove_all("Nome ANP do ")
  i <- i + 1
}
```



```{r}
maiores_pocos_terrestres_petroleo <- map_df(lista_guia4_todas, `[[`, 4)
```

## 30 maiores poços terrestres gás natural

```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(5)

read_excel(paste0("data/", planilhas[32]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(5)

read_excel(paste0("data/", planilhas[4]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(5)
```

```{r}
try(map_df(lista_guia4_todas, `[[`, 5))
```

```{r}
i <- 1
for(i in seq_along(lista_guia4_todas)) {
  names(lista_guia4_todas[[i]][[5]] )[6] |> print() 
  i <- i + 1
}
```



1. Acertar os nomes das colunas

```{r}
i <- 1
for(i in seq_along(lista_guia4_todas)) {
  names(lista_guia4_todas[[i]][[5]] ) <- names(lista_guia4_todas[[i]][[5]] ) |> 
  str_replace_all(pattern = "Natural", replacement = "natural") |>
  str_replace_all(pattern = "natural  (Mm³/d)", replacement = "natural (Mm³/d)") |>
    str_replace_all(pattern = "Operador/Concessionário", replacement = "Operador") |> 
    str_replace_all(pattern = "Gás natural (Mm³/d)", replacement = "Gás natural  (Mm³/d)") |>
    str_remove_all("Nome ANP do ") |> 
    str_trim()
  i <- i + 1
}
```

```{r}
maiores_pocos_terrestres_gas_natural <- map_df(lista_guia4_todas, `[[`, 5) 
```




```{r}
try(map_df(lista_guia4_todas, `[[`, 6))
```

1. Acertar os nomes das colunas

```{r}
i <- 1
for(i in seq_along(lista_guia4_todas)) {
  names(lista_guia4_todas[[i]][[6]] ) <- names(lista_guia4_todas[[i]][[6]] ) |> 
  str_replace_all(pattern = "Plataforma", replacement = "Instalação") |>
  str_replace_all(pattern = "natural  (Mm³/d)", replacement = "natural (Mm³/d)") |>
  str_remove_all("Nome ANP do ") |> 
    str_trim()
  i <- i + 1
}
```


```{r}
try(map_df(lista_guia4_todas, `[[`, 6))
```

## 30 maiores instalações de produção de petróleo

```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(6)

read_excel(paste0("data/", planilhas[32]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(6)

read_excel(paste0("data/", planilhas[4]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(6)
```

```{r}
try(map_df(lista_guia4_todas, `[[`, 7))
```

## 2. Verificar qual DF tem colunas demais 

```{r}
i <- 1
for(i in 60:70){
ncol(lista_guia4_todas[[i]][[7]]) |> print()
  i <- 1 + 1
}
```
# DF 69

```{r}
lista_guia4_todas[[69]][[7]] <- lista_guia4_todas[[69]][[7]] |> 
  select(!6:13)
```

1. Acertar os nomes das colunas

```{r}
i <- 1
for(i in seq_along(lista_guia4_todas)) {
  names(lista_guia4_todas[[i]][[7]] ) <- names(lista_guia4_todas[[i]][[7]] ) |> 
  str_replace_all(pattern = "Plataforma", replacement = "Instalação") |>
  str_replace_all(pattern = "natural  (Mm³/d)", replacement = "natural (Mm³/d)") |>
  str_remove_all("Nome ANP do ") |> 
  str_replace_all(pattern = "Nº poços produtores", replacement = "Nº poços  produtores") |>  
  str_replace_all(pattern = "Campos Produtores", replacement = "Campos produtores") |>   
  str_trim()
  i <- i + 1
}
```


## 1. Retirar a coluna `Nº`


```{r}


# Se a coluna N não aparece em todos os dataframes da lista:

i <- 1
for(i in seq_along(lista_guia4_todas)){

  if( names(lista_guia4_todas[[i]][[7]]) |> 
  str_detect("Nº") |> sum() > 1 ) {lista_guia4_todas[[i]][[7]] <- lista_guia4_todas[[i]][[7]] |> select(!"Nº")}
  
  i <- 1 + 1
}

```


```{r}
maiores_instalacoes_gas <- map_df(lista_guia4_todas, `[[`, 7)
```

## Campos com maior queima
```{r}
read_excel(paste0("data/", planilhas[76]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(7)

read_excel(paste0("data/", planilhas[32]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(7)

read_excel(paste0("data/", planilhas[4]), sheet = 4, col_types = "text",  .name_repair = "unique_quiet") |> 
  filter(if_any(1, ~ str_detect(., "Tabela"))) |> 
  select(1) |> 
  slice(7)
```

```{r}
try(map_df(lista_guia4_todas, `[[`, 8))
```

## 2. Verificar qual DF tem colunas demais 

```{r}
meu_dataframe <- data.frame()
i <- 1
for(i in seq_along(lista_guia4_todas)){
meu_dataframe[i,1] <- ncol(lista_guia4_todas[[i]][[8]]) 
  i <- 1 + 1
}

 
meu_dataframe |> 
  mutate(V2 = 1:nrow(meu_dataframe)) |> 
  filter(V1 > 10)
```
Dataframes 47 e 72 têm problemas

```{r}
lista_guia4_todas[[47]][[8]] <- lista_guia4_todas[[47]][[8]] |> 
  select(!7:11)
  
lista_guia4_todas[[72]][[8]] <- lista_guia4_todas[[72]][[8]] |> 
    select(!7:12)
```


```{r}
maiores_queimas <- map_df(lista_guia4_todas, `[[`, 8)
```






# Tabelas geradas

Todas as tabelas são exportadas como arquivos csv, no diretório "saida":


```{r}
Historico_petroleo |> 
  write_csv("csv/tabela01_Historico_petroleo.csv", )

Historico_prod_gas |> 
  write_csv("csv/tabela02_Historico_prod_gas.csv")

MOVIMENTACAO_DE_GAS_NATURAL |> 
  write_csv("csv/tabela03_MOVIMENTACAO_DE_GAS_NATURAL.csv")

Historico_de_Producao_de_Petroleo_Gas_Natural |> 
  write_csv("csv/tabela04_Historico_de_Producao_de_Petroleo_Gas_Natural.csv")

por_estado |> 
  write_csv("csv/tabela05_Producao_por_estado.csv")

por_bacia |> 
  write_csv("csv/tabela06_Producao_por_bacia.csv")

por_operador |> 
  write_csv("csv/tabela07_Producao_por_operador.csv")

por_concessionario |> 
  write_csv("csv/tabela08_Producao_por_concessionario.csv")

MOVIMENTACAO_GAS_NATURAL_POR_DESTINO |> 
  write_csv("csv/tabela09_MOVIMENTACAO_GAS_NATURAL_POR_DESTINO.csv")

DISTRIBUICAO_DA_PRODUCAO_CAMPOS_PRE_SAL |> 
  write_csv("csv/tabela10_DISTRIBUICAO_DA_PRODUCAO_CAMPOS_PRE_SAL.csv")

maiores_pocos_de_petroleo |> 
  write_csv("csv/tabela11_maiores_pocos_de_petroleo.csv")

maiores_pocos_de_gas |> 
  write_csv("csv/tabela12_maiores_pocos_de_gas.csv")

maiores_pocos_producao_total |> 
  write_csv("csv/tabela13_maiores_pocos_producao_total.csv")

maiores_pocos_terrestres_petroleo |> 
  write_csv("csv/tabela14_maiores_pocos_terrestres_petroleo.csv")

maiores_pocos_terrestres_gas_natural |> 
  write_csv("csv/tabela15_maiores_pocos_terrestres_gas_natural.csv")

maiores_instalacoes |> 
  write_csv("csv/tabela16_maiores_instalações.csv")
  
maiores_instalacoes_gas |> 
  write_csv("csv/tabela17_maiores_instalacoes_gas.csv")

maiores_queimas |> 
write_csv("csv/tabela18_maiores_queimas.csv")
```


