---
title: "Obter tabelas - guias covid"
author: "BML"
date: "2024-07-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
```

```{r warning=FALSE}
# Rodar o arquivo worksheets e data

source(knitr::purl("worksheets_data.Rmd", quiet=TRUE))

```

# Funções personalizadas

```{r}
read_excel_data  <- function(x,sheet = 2, range = "A1:J1000", skip = 0, n_max = Inf)
  {read_xlsx(paste0("data/", x), 
            col_types = "text",
            sheet = sheet,
            range = range,
            skip = skip,
            col_names = FALSE,
            n_max = n_max,
            .name_repair = "unique_quiet",)}

```


# Tabelas na guia 5

Criar dataframe com o número de guias em todos os arquivos baixados
```{r}
i <- 1
numero_guias <- integer()
for(i in seq_along(planilhas)){
numero_guias[i] <- excel_sheets(paste0("data/", planilhas[i])) |> length()  
i <- i + 1
}

numero_guias_df <- tibble(planilha = seq_along(lista_guias),
           "numero de guias" =  numero_guias)

numero_guias_df
```
```{r}
numero_guias_df |> 
  count(`numero de guias`)
```

Temos planilhas com 4 guias, e 10 com 5 guias.

Em seguida, vamos verificar quais planilhas têm 5 guias.
```{r}
planilhas_com_5_guias <- numero_guias_df |> 
  filter(`numero de guias` > 4) |> 
  pull(planilha)

planilhas_com_5_guias

```
Verificar o nome das planilhas com mais de quatro guias, e o nome da quinta guia:

```{r}
i <- min(planilhas_com_5_guias)

nome_guia <- character()

for(i in planilhas_com_5_guias){
  nome_guia[i] <- excel_sheets(paste0("data/", planilhas[i]))[5]   
  i <- i +1
}

# Filtrar vetor, para mostrar apenas linhas que contenham valores
nome_guia[!is.na(nome_guia)]

```
Assim, quando a planilha tem 5 guias, ela trata de dados relativos à pandemia da Covid.

## Obter dados

Vamos obter os nomes das tabelas que estão na guia 5. 
```{r}
map_df(planilhas[planilhas_com_5_guias], read_excel_data, sheet = 5) |> 
  filter(if_any(2, ~ str_detect(., "Tabela"))) |> 
  distinct() |> 
  # apagar colunas sem dados
  select_if(~all(!is.na(.)))
```
Portanto, há duas tabelas, de número 20 e 21, nas guias de número 5.

```{r}
extrair_todas_tabelas(planilhas_com_5_guias[1], sheet = 5)
```

As duas tabelas importadas precisam ser limpas.

20: criar cópia da tabela, apagar as linhas após a linha "TOTAL DE CAMPOS INTERROMPIDOS" 
Na tabela copiada, manter as três linhas chamadas de "TOTAL DE CAMPOS"

21: criar cópia da tabela, apagar as linhas após a linha "* Antecipou parada programada" (verificar se essa frase aparece sempre)
Na tabela copiada, manter as três linhas chamadas de "Total de UEPs" e "Unidades"


Gerar lista com todas as tabelas

```{r}
lista_guia5 <- map(planilhas_com_5_guias, extrair_todas_tabelas, sheet = 5)
lista_guia5
```
Limpeza da primeira tabela
```{r}
teste <-lista_guia5

# copiar dataframe
teste[[1]][[3]] <- teste[[1]][[1]]

# apagar a partir de determinada linha
teste[[1]][[1]] |> 
  select(1) |> 
  str_detect("TOTAL") 



which(str_detect(prov1$col1, "Tabela [0-9]*"))
```

