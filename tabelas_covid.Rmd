---
title: "Obter tabelas - guias covid"
author: "BML"
date: "2024-07-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
```

```{r warning=FALSE, include=FALSE}
# Rodar o arquivo worksheets e data

source(knitr::purl("funcoes_data_e_extrair.Rmd", quiet=TRUE))

```

# Funções personalizadas

```{r}
read_excel_data  <- function(x,sheet = 2, range = "A1:J1000", skip = 0, n_max = Inf)
  {read_xlsx(paste0("data/", x), 
            col_types = "text",
            sheet = sheet,
            range = range,
            skip = skip,
            col_names = FALSE,
            n_max = n_max,
            .name_repair = "unique_quiet",)}

```


# Tabelas na guia 5

Criar dataframe com o número de guias em todos os arquivos baixados
```{r}
i <- 1
numero_guias <- integer()
for(i in seq_along(planilhas)){
numero_guias[i] <- excel_sheets(paste0("data/", planilhas[i])) |> length()  
i <- i + 1
}

numero_guias_df <- tibble(planilha = seq_along(numero_guias),
           "numero de guias" =  numero_guias)

numero_guias_df
```
Resumindo essa tabela de dados:
```{r}
numero_guias_df |> 
  count(`numero de guias`)
```

Temos planilhas com 4 guias, e 10 com 5 guias.

Em seguida, vamos verificar quais planilhas têm 5 guias.
```{r}
planilhas_com_5_guias <- numero_guias_df |> 
  filter(`numero de guias` > 4) |> 
  pull(planilha)

planilhas_com_5_guias

```
Verificar o nome das planilhas com mais de quatro guias, e o nome da quinta guia:

```{r}
i <- min(planilhas_com_5_guias)

nome_guia <- character()

for(i in planilhas_com_5_guias){
  nome_guia[i] <- excel_sheets(paste0("data/", planilhas[i]))[5]   
  i <- i +1
}

# Filtrar vetor, para mostrar apenas linhas que contenham valores
nome_guia[!is.na(nome_guia)]

```
Assim, quando a planilha tem 5 guias, ela trata de dados relativos à pandemia da Covid.

## Obter dados

Vamos obter os nomes das tabelas que estão na guia 5. 
```{r}
map_df(planilhas[planilhas_com_5_guias], read_excel_data, sheet = 5) |> 
  filter(if_any(2, ~ str_detect(., "Tabela"))) |> 
  distinct() |> 
  # apagar colunas sem dados
  select_if(~all(!is.na(.)))
```
# Criar lista 

Portanto, há duas tabelas, de número 20 e 21, nas guias de número 5.

```{r}
extrair_todas_tabelas(planilhas_com_5_guias[1], sheet = 5)
```

# Limpar lista
As duas tabelas importadas precisam ser limpas.

20: criar cópia da tabela, apagar as linhas após a linha "TOTAL DE CAMPOS INTERROMPIDOS" 
Na tabela copiada, manter as três linhas chamadas de "TOTAL DE CAMPOS"

21: criar cópia da tabela, apagar as linhas após a linha "* Antecipou parada programada" (verificar se essa frase aparece sempre)
Na tabela copiada, manter as três linhas chamadas de "Total de UEPs" e "Unidades"


Gerar lista com todas as tabelas

```{r}
lista_guia5 <- map(planilhas_com_5_guias, extrair_todas_tabelas, sheet = 5)
lista_guia5
```
Limpeza da primeira tabela
```{r eval=FALSE, include=FALSE}
teste <-lista_guia5

# copiar dataframe
my_df1 <- teste[[1]][[1]]

# identificar linhas que aparecem com a palavra "Total"
linhas_total <- which(str_detect(my_df1$Campos, "TOTAL"))

# Selecionar linhas com total e limpar colunas que não fazem sentido
my_df1 <- my_df1[c(linhas_total),c(1,3)] 
  
my_df1[,c(1,3, ncol(my_df1))] 

names(my_df1)[1] <- "Total"
names(my_df1)[2] <- "n"
my_df1

# copiar dataframe
my_df <- teste[[2]][[1]]

# identificar linhas que aparecem com a palavra "Total"
linhas_total <- which(str_detect(my_df$Campos, "TOTAL"))

# Selecionar linhas com total e limpar colunas que não fazem sentido
my_df[c(linhas_total),]
my_df <- my_df[c(linhas_total),c(1,3)] 
  
my_df[,c(1,3, ncol(my_df))] 

names(my_df)[1] <- "Total"
names(my_df)[2] <- "n"


# Copiar para a lista
teste[[2]][[3]] <- data.frame()
teste[[2]][[3]] <- my_df

# apagar linhas do df original

ultima_linha <- linhas_total[1]-1

teste[[2]][[1]] <- teste[[2]][[1]][1:ultima_linha,] |> 
  filter(!is.na(Campos))


```

Iteração da primeira tabela

```{r}
i <- 1
for(i in seq_along(lista_guia5)){

  # copiar dataframe
my_df <- lista_guia5[[i]][[1]]

# identificar linhas que aparecem com a palavra "Total"
linhas_total <- which(str_detect(my_df$Campos, "TOTAL"))

# Selecionar linhas com total e limpar colunas que não fazem sentido
my_df <- my_df[c(linhas_total),c(1,3, ncol(my_df))] 

  
names(my_df)[1] <- "Total"
names(my_df)[2] <- "n"

# Copiar para a lista
lista_guia5[[i]][[3]] <- data.frame()
lista_guia5[[i]][[3]] <- my_df

# apagar linhas do df original

ultima_linha <- linhas_total[1]-1

lista_guia5[[i]][[1]] <- lista_guia5[[i]][[1]][1:ultima_linha,] |> 
  filter(!is.na(Campos)) 

i <- i + 1
}
```

```{r eval=FALSE, include=FALSE}
lista_guia5
```

Limpeza da segunda tabela

```{r eval=FALSE, include=FALSE}
teste <-lista_guia5

# copiar dataframe

my_df <- teste[[2]][[2]]

names(my_df)[1] <- "Total"
names(my_df)[3] <- "n"

linhas_total <- which(str_detect(my_df$Total, "Total"))

# Selecionar linhas com total e limpar colunas que não fazem sentido
my_df <-  my_df[linhas_total:nrow(my_df),] |> 
  filter(!is.na(Total)) |> 
    select(c(1,3,ncol(my_df)))
  
# Colocar no dataframe 4 da lista

teste[[2]][[4]] <- data.frame()
teste[[2]][[4]] <- my_df

# apagar linhas do df original

teste[[2]][[2]] <- teste[[2]][[2]][1:(linhas_total -1),] |> 
  filter(!is.na(Campo))

teste[[2]][[2]]  
teste[[2]][[4]]
```


Iteração da segunda tabela

```{r}
i <- 1
for(i in seq_along(lista_guia5)){

  # copiar dataframe

my_df <- lista_guia5[[i]][[2]]

names(my_df)[1] <- "Total"
names(my_df)[3] <- "n"

linhas_total <- which(str_detect(my_df$Total, "Total"))

# Selecionar linhas com total e limpar colunas que não fazem sentido
my_df <-  my_df[linhas_total:nrow(my_df),] |> 
  filter(!is.na(Total)) |> 
    select(c(1,3,ncol(my_df)))
  
# Colocar no dataframe 4 da lista

lista_guia5[[i]][[4]] <- data.frame()
lista_guia5[[i]][[4]] <- my_df

# apagar linhas do df original

lista_guia5[[i]][[2]] <- lista_guia5[[i]][[2]][1:(linhas_total -1),] |> 
  filter(!is.na(Campo))
  
  i <- i + 1  
}
  
```

```{r}
lista_guia5
```

# Separa lista


Tabela 1

```{r}
try(map_df(lista_guia5, `[[`, 1))

```
```{r}
map_df(lista_guia5, `[[`, 2)

```
```{r}
map_df(lista_guia5, `[[`, 3)

```

```{r}
map_df(lista_guia5, `[[`, 4)

```

Resultado mostra que primeira tabela deve ter dados extraídos de outra coluna