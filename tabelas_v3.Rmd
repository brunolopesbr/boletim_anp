---
title: "Worksheets"
author: "BML"
date: "2024-07-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
```

# Funções personalizadas



# Datas

Gerando elemento com todos os arquivos e suas datas
```{r message=FALSE, warning=FALSE}

datas_arquivos
```

# Guias


Guias 3: sempre com o mesmo nome

```{r}
unique(guias$V3)

```

Tabelas na guia 2:
Planilhas 1 a 3: 13 tabelas, de 4 a 16
```{r}
map_df(1:3, function(x){read_excel(paste0("data/", planilhas[x]), range = "A1:Z1000", sheet = 3, col_types = "text",  .name_repair = "unique_quiet")}) |> 
  filter(if_any(2, ~ str_detect(., "Tabela"))) |> 
  distinct()
```


Extraindo dados da guia 3 de uma planilha

Criar função personalizada para extrair 13 tabelas

```{r}

extrair_tabelas_2017_ws3 <- function(nume, ajuste = 2, ajuste2 = -2, sheet = 3){
mes_boletim <- datas_arquivos[[nume,1]]

  prov <- read_excel(paste0("data/", planilhas[nume]), sheet = 3)

names(prov) <- "col1"

  corte <- which(str_detect(prov$col1, "Tabela [0-9]*"))
  # E a a linha seguinte com a palavra tabela indica o início da tabela seguinte
  maximo_linha <- lead(corte) - corte
  
ajuste <- 2
ajuste2 <- -2

my_list <- list()
  
  # Importação de três tabelas, usando os parâmetros descobertos anteriormente
  # nos argumentos "skip" e "n_max". Dessa maneira, a função readxl identifica
  # automaticamente o número de colunas de cada tabela e a classe dos caracteres

 assign(x = paste0("dataf", 1), value = read_excel(paste0("data/", planilhas[nume]), sheet = 3, skip = corte[1] + 
  ajuste, n_max = maximo_linha[1] + ajuste2) |> 
          mutate(mes = mes_boletim))    

 assign(x = paste0("dataf", 2), value = read_excel(paste0("data/", planilhas[nume]), sheet = 3, skip = corte[2] + 
  ajuste, n_max = maximo_linha[2] + ajuste2) |> 
          mutate(mes = mes_boletim))
 
  assign(x = paste0("dataf", 3), value = read_excel(paste0("data/", planilhas[nume]), sheet = 3, skip = corte[3] + 
  ajuste, n_max = maximo_linha[3] + ajuste2) |> 
          mutate(mes = mes_boletim))
  
   assign(x = paste0("dataf", 4), value = read_excel(paste0("data/", planilhas[nume]), sheet = 3, skip = corte[4] + 
  ajuste, n_max = maximo_linha[4] + ajuste2) |> 
          mutate(mes = mes_boletim))
 
   assign(x = paste0("dataf", 5), value = read_excel(paste0("data/", planilhas[nume]), sheet = 3, skip = corte[5] + 
  ajuste, n_max = maximo_linha[5] + ajuste2) |> 
          mutate(mes = mes_boletim))
   
      assign(x = paste0("dataf", 6), value = read_excel(paste0("data/", planilhas[nume]), sheet = 3, skip = corte[6] + 
  ajuste, n_max = maximo_linha[6] + ajuste2) |> 
          mutate(mes = mes_boletim))
      
      assign(x = paste0("dataf", 7), value = read_excel(paste0("data/", planilhas[nume]), sheet = 3, skip = corte[7] + 
  ajuste, n_max = maximo_linha[7] + ajuste2) |> 
          mutate(mes = mes_boletim))
      
            assign(x = paste0("dataf", 8), value = read_excel(paste0("data/", planilhas[nume]), sheet = 3, skip = corte[8] + 
  ajuste, n_max = maximo_linha[8] + ajuste2) |> 
          mutate(mes = mes_boletim))
   
               assign(x = paste0("dataf", 9), value = read_excel(paste0("data/", planilhas[nume]), sheet = 3, skip = corte[9] + 
  ajuste, n_max = maximo_linha[9] + ajuste2) |> 
          mutate(mes = mes_boletim))         
            
                  assign(x = paste0("dataf", 10), value = read_excel(paste0("data/", planilhas[nume]), sheet = 3, skip = corte[10] + 
  ajuste, n_max = maximo_linha[10] + ajuste2) |> 
          mutate(mes = mes_boletim))
               
                                    assign(x = paste0("dataf", 11), value = read_excel(paste0("data/", planilhas[nume]), sheet = 3, skip = corte[11] + 
  ajuste, n_max = maximo_linha[11] + ajuste2) |> 
          mutate(mes = mes_boletim))
                  
                                       assign(x = paste0("dataf", 12), value = read_excel(paste0("data/", planilhas[nume]), sheet = 3, skip = corte[12] + 
  ajuste, n_max = maximo_linha[12] + ajuste2) |> 
          mutate(mes = mes_boletim))
                                    
# i <- 1
# while(i < 13){
# assign(x = paste0("dataf", i), value = read_excel(paste0("data/", planilhas[i]), sheet = 3, skip = corte[i], n_max = maximo_linha[i]) |> 
#          mutate(mes = mes_boletim))
#  
#  i <- i + 1
#}

 assign(x = paste0("dataf", 13), value = read_excel(paste0("data/", planilhas[nume]), sheet = 3, skip = corte[13] + ajuste) |> 
          mutate(mes = mes_boletim))  

mylist <- list(dataf1, dataf2, dataf3, dataf4, dataf5, dataf6, dataf7, dataf8, dataf9, dataf10, dataf11, dataf12, dataf13)

mylist
}
```
Criar lista com tabelas de 2017
```{r}
tabelas_guias2_2017_lista <- map(1:3, extrair_tabelas_2017_ws3)

```
Acertar nomes de dataframes
```{r}
names(tabelas_guias2_2017_lista[[1]][[1]]) <- names(tabelas_guias2_2017_lista[[2]][[1]])
names(tabelas_guias2_2017_lista[[1]][[2]]) <- names(tabelas_guias2_2017_lista[[2]][[2]])
```

```{r}
length(tabelas_guias2_2017_lista)
```



```{r}
do.call(rbind, lapply(tabelas_guias2_2017_lista, `[[`, 3))
```
```{r}
do.call(rbind, lapply(tabelas_guias2_2017_lista, `[[`, 4))
```



```{r}
do.call(rbind, lapply(tabelas_guias2_2017_lista, `[[`, 5))
```
```{r}
do.call(rbind, lapply(tabelas_guias2_2017_lista, `[[`, 6))
```
A lista 7 não pode passar direto por um rbind. Precisa ser limpa com a função "gather' antes

```{r}
rbind(tabelas_guias2_2017_lista[[1]][[7]][,-15] |> 
  tidyr::pivot_longer(cols = 2:14, names_to = "mes_ano", values_to = "valor"),

tabelas_guias2_2017_lista[[2]][[7]][,-15] |> 
  tidyr::pivot_longer(cols = 2:14, names_to = "mes_ano", values_to = "valor"),

tabelas_guias2_2017_lista[[3]][[7]][,-15] |> 
  tidyr::pivot_longer(cols = 2:14, names_to = "mes_ano", values_to = "valor")) |> 
  distinct()
```

```{r}
do.call(rbind, lapply(tabelas_guias2_2017_lista, `[[`, 8))
```
```{r}
do.call(rbind, lapply(tabelas_guias2_2017_lista, `[[`, 9))
```

```{r}
do.call(rbind, lapply(tabelas_guias2_2017_lista, `[[`, 10))
```

```{r}
do.call(rbind, lapply(tabelas_guias2_2017_lista, `[[`, 11))
```

```{r}
do.call(rbind, lapply(tabelas_guias2_2017_lista, `[[`, 12))
```

```{r}
do.call(rbind, lapply(tabelas_guias2_2017_lista, `[[`, 13))
```



### Planilhas 3 à última: 9 tabelas, de 5 a 11
```{r}
map_df(4:length(planilhas), function(x){read_excel(paste0("data/", planilhas[x]), range = "A1:Z1000", sheet = 3, col_types = "text",  .name_repair = "unique_quiet")}) |> 
  filter(if_any(2, ~ str_detect(., "Tabela"))) |> 
  distinct()
```

Função personalizada: extrair 8 tabelas